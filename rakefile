require 'erb'

require 'rake/clean'

require 'fileutils'

load '../z80-libraries/tasks.rake'

CLEAN.include("**/*.o", "**/*.bin", "**/*.hex", "**/*.diss", "**/*.lib", "**/*.lis", "**/*.map", "**/*.sym", "**/*.exe")

namespace 'build' do
    desc "Build boot sector image"
    task 'boot' do
        cmd = "zcc "
        cmd += "+#{CONFIG} -compiler-sccz80 "
        cmd += "-O2 -SO2 "
        cmd += "-L#{LIB} -I#{LIB_INCLUDE} "
        cmd += "-Ca\"-I#{LIB_INCLUDE}\" "
        cmd += "--no-crt "
        cmd += "-o bootsector_temp.bin "
        cmd += "boot/bootsector.asm"

        success = system(cmd)

        if success
            # Pad to 512 bytes.
            bin = File.read("bootsector_temp.bin", mode: "rb")
            abort("Boot sector too large: size is #{bin.size}") if bin.size > 512
            File.open("bootsector.bin", "wb") do |f|
                bin.bytes.each do |b|
                    f.putc b
                end

                (512-bin.size).times do
                    f.putc 0
                end
            end

            system("z88dk-dis -o 0x8000 bootsector.bin > bootsector.diss")
        end
    end

    desc "Build 2nd stage loader image"
    task 'loader' => ['lib:stdlib'] do
        cmd = "zcc "
        cmd += "+#{CONFIG} -compiler-sccz80 "
        cmd += "-O2 -SO2 "
        cmd += "-L#{LIB} -I#{LIB_INCLUDE} "
        cmd += "-Ca\"-I#{LIB_INCLUDE}\" "
        cmd += "-Cl\"-r0x8200\" "
        cmd += "-crt0 loader/reset.asm "
        cmd += "-m "
        cmd += "-o loader_temp.bin "
        cmd += "loader/*.c "
        cmd += "loader/*.asm "

        success = system(cmd)

        if success
            num_sectors = 9

            bin = File.read("loader_temp.bin", mode: "rb")
            abort("Loader image too large: size is #{bin.size} (#{512 * num_sectors} expected)") if bin.size > (512*num_sectors)

            File.open("loader.bin", "wb") do |f|
                bin.bytes.each do |b|
                    f.putc b
                end

                ((512*num_sectors)-bin.size).times do
                    f.putc 0
                end
            end

            system("z88dk-dis -o 0x8200 loader.bin > loader.diss")

            File.open("loader.bin", "rb") do |f|
                num_sectors.times do |i|
                    File.open("loader_#{i+1}.bin", "wb") do |f_out|
                        512.times do
                            f_out.putc f.getc
                        end
                    end
                end
            end
        end
    end

    desc "Build kernel image"
    task 'kernel' => ['lib:stdlib'] do
        # Include every source file but reset.asm, which is the startup code.
        src = (Dir.glob("kernel/*.asm") + Dir.glob("kernel/*.c")) - ["kernel/reset.asm"]

        cmd = "zcc "
        cmd += "+#{CONFIG} -compiler-sccz80 "
        cmd += "-O2 -SO2 "
        cmd += "-DZ88DK "
        cmd += "-Ikernel "
        cmd += "-L#{LIB} -I#{LIB_INCLUDE} "
        cmd += "-Ca\"-I#{LIB_INCLUDE}\" "
        cmd += "-Cl\"-r0x0000\" "
        cmd += "-crt0 kernel/reset.asm "
        cmd += "-lstdlib "
        cmd += "-m "
        cmd += "-o kernel.bin "
        cmd += src.join(" ")

        success = system(cmd)

        if success
            system("z88dk-dis -o 0x0000 kernel.bin > kernel.diss")

            # Make sure that the kernel image is no more than 23Kb in size.
            limit = 23 * 1024
            bin = File.read("kernel.bin", mode: "rb")
            abort("Kernel image is too large: size is #{bin.size} (#{limit} expected)") if bin.size > limit
        end
    end

    desc "Build command processor image"
    task 'command' => ['lib:stdlib'] do
        # Include every source file but reset.asm, which is the startup code.
        src = (Dir.glob("command/*.asm") + Dir.glob("command/*.c")) - ["command/reset.asm"]

        cmd = "zcc "
        cmd += "+#{CONFIG} -compiler-sccz80 "
        cmd += "-O2 -SO2 "
        cmd += "-L#{LIB} -I#{LIB_INCLUDE} "
        cmd += "-Ca\"-I#{LIB_INCLUDE}\" "
        cmd += "-Cl\"-r0x6000\" "
        cmd += "-crt0 command/reset.asm "
        cmd += "-lstdlib "
        cmd += "-m "
        cmd += "-o command.bin "
        cmd += src.join(" ")

        success = system(cmd)

        if success
            system("z88dk-dis -o 0x6000 command.bin > command.diss")

            # Make sure that the command processor image is no more than 8Kb in size.
            limit = 8 * 1024
            bin = File.read("command.bin", mode: "rb")
            abort("Command processor image is too large: size is #{bin.size} (#{limit} expected)") if bin.size > limit
        end
    end

    Dir.glob("builtin/*").each do |builtin|
        builtin_name = File.basename(builtin)

        desc "Build executable for builtin program '#{builtin_name}'"
        task "builtin:#{builtin_name}" => ['lib:stdlib'] do
            src = (Dir.glob("#{builtin}/*.asm") + Dir.glob("#{builtin}/*.c"))

            cmd = "zcc "
            cmd += "+#{CONFIG} -compiler-sccz80 "
            cmd += "-O2 -SO2 "
            cmd += "-L#{LIB} -I#{LIB_INCLUDE} "
            cmd += "-Ca\"-I#{LIB_INCLUDE}\" "
            cmd += "-Cl\"-r0x8000\" "
            cmd += "-crt0 #{LIB}/crt0.asm "
            cmd += "-lstdlib "
            cmd += "-m "
            cmd += "-o #{builtin_name}.exe "
            cmd += src.join(" ")

            success = system(cmd)

            if success
                system("z88dk-dis -o 0x8000 #{builtin_name}.exe > #{builtin_name}.diss")
            end
        end
    end

    desc "Build all"
    task "all" => ["loader", "boot", "kernel", "command"]
end

namespace 'install' do
    desc "Install kernel image onto CF-card"
    task 'kernel', [:path] => ['build:kernel'] do |t, args|
        abort("No path specified") if args[:path].nil?
        FileUtils.cp('kernel.bin', File.join(args[:path], 'KERNEL.BIN'))
    end

    desc "Install command processor image onto CF-card"
    task 'command', [:path] => ['build:command'] do |t, args|
        abort("No path specified") if args[:path].nil?
        FileUtils.cp('command.bin', File.join(args[:path], 'COMMAND.BIN'))
    end

    Dir.glob("builtin/*").each do |builtin|
        builtin_name = File.basename(builtin)

        desc "Install executable for builtin program '#{builtin_name}'"
        task "builtin:#{builtin_name}", [:path] => ["build:builtin:#{builtin_name}"] do |t, args|
            abort("No path specified") if args[:path].nil?
            FileUtils.cp("#{builtin_name}.exe", File.join(args[:path], "#{builtin_name.upcase}.EXE"))
        end
    end
end

namespace 'test' do
    namespace 'kernel' do
    desc "Run kernel unit tests"
        task 'unit' do
            # Delete test exe and main.c if they exist.
            if File.exist? "test_kernel.exe"
                FileUtils.rm "test_kernel.exe"
            end

            if File.exist? "kernel/unit_test/main.c"
                FileUtils.rm "kernel/unit_test/main.c"
            end
            
            tests = []

            # Get tests from test files.
            Dir.glob("kernel/unit_test/*.c").each do |f|
                File.readlines(f).each do |l|
                    if /int (test_\S+)\(\)/ =~ l
                        tests << $1
                    end
                end
            end

            # Create the templated main.
            template = File.read("kernel/unit_test/main.c.erb")
            erb = ERB.new(template)
            File.write("kernel/unit_test/main.c", erb.result(binding))

            # Compile test/main.c, other test/*.c, and kernel files for which
            # a file exists under test.
            # Include every source file but reset.asm, which is the startup code.
            src = []

            Dir.glob("kernel/unit_test/*.c").each do |f|
                next if f == "kernel/unit_test/main.c"

                src << f
                src << "kernel/#{File.basename(f)}"
            end

            # Add mock files
            Dir.glob("kernel/unit_test/mock/*.c").each do |f|
                src << f
            end

            cmd = "gcc "
            cmd += "-g -O1 "
            cmd += "-Ikernel "
            cmd += "-Ikernel/unit_test/mock "
            cmd += "-o test_kernel.exe "
            cmd += src.join(" ")
            cmd += " kernel/unit_test/main.c"

            system(cmd)

            # Now run tests.
            if (!system("./test_kernel.exe"))
                puts "TESTS FAILED"
            else
                puts "TESTS PASSED"
            end
        end
    end
end

task "test" => ["test:kernel:unit"]

task "install", [:path] => ["install:kernel", "install:command"] + Dir.glob("builtin/*").map { |builtin| "install:builtin:#{File.basename(builtin)}" }
